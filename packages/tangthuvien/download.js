const puppeteer = require("puppeteer");
const fs = require("fs");
const fsPromises = require("fs/promises");
const path = require("path");

const { hideHeadless } = require("../../stealth");

const VIEWPORT_WIDTH = 800;
const VIEWPORT_HEIGHT = 600;
const CHAPTER_DOMAIN =
  "https://truyen.tangthuvien.vn/doc-truyen/trong-sinh-chi-dang-nhi-truong-dai";
const CHAPTERS = [
  "chuong-1",
  "chuong-2",
  "chuong-3",
  "chuong-4",
  "chuong-5",
  "chuong-6",
  "chuong-7",
  "chuong-8",
  "chuong-9",
  "chuong-10",
  "chuong-11",
  "chuong-12",
  "chuong-13",
  "chuong-14",
  "chuong-15",
  "chuong-16",
  "chuong-17",
  "chuong-18",
  "chuong-19",
  "chuong-20",
  "chuong-21",
  "chuong-22",
  "chuong-23",
  "chuong-24",
  "chuong-25",
  "chuong-26",
  "chuong-27",
  "chuong-28",
  "chuong-29",
  "chuong-30",
  "chuong-31",
  "chuong-32",
  "chuong-33",
  "chuong-34",
  "chuong-35",
  "chuong-36",
  "chuong-37",
  "chuong-38",
  "chuong-39",
  "chuong-40",
  "chuong-41",
  "chuong-42",
  "chuong-43",
  "chuong-44",
  "chuong-45",
  "chuong-46",
  "chuong-47",
  "chuong-48",
  "chuong-49",
  "chuong-50",
  "chuong-51",
  "chuong-52",
  "chuong-53",
  "chuong-54",
  "chuong-55",
  "chuong-56",
  "chuong-57",
  "chuong-58",
  "chuong-59",
  "chuong-60",
  "chuong-61",
  "chuong-62",
  "chuong-63",
  "chuong-64",
  "chuong-65",
  "chuong-66",
  "chuong-67",
  "chuong-68",
  "chuong-69",
  "chuong-70",
  "chuong-71",
  "chuong-72",
  "chuong-73",
  "chuong-74",
  "chuong-75",
  "chuong-76",
  "chuong-77",
  "chuong-78",
  "chuong-79",
  "chuong-80",
  "chuong-81",
  "chuong-82",
  "chuong-83",
  "chuong-84",
  "chuong-85",
  "chuong-86",
  "chuong-87",
  "chuong-88",
  "chuong-89",
  "chuong-90",
  "chuong-91",
  "chuong-92",
  "chuong-93",
  "chuong-94",
  "chuong-95",
  "chuong-96",
  "chuong-97",
  "chuong-98",
  "chuong-99",
  "chuong-100",
  "chuong-101",
  "chuong-102",
  "chuong-103",
  "chuong-104",
  "chuong-105",
  "chuong-106",
  "chuong-107",
  "chuong-108",
  "chuong-109",
  "chuong-110",
  "chuong-111",
  "chuong-112",
  "chuong-113",
  "chuong-114",
  "chuong-115",
  "chuong-116",
  "chuong-117",
  "chuong-118",
  "chuong-119",
  "chuong-120",
  "chuong-121",
  "chuong-122",
  "chuong-123",
  "chuong-124",
  "chuong-125",
  "chuong-126",
  "chuong-127",
  "chuong-128",
  "chuong-129",
  "chuong-130",
  "chuong-131",
  "chuong-132",
  "chuong-133",
  "chuong-134",
  "chuong-135",
  "chuong-136",
  "chuong-137",
  "chuong-138",
  "chuong-139",
  "chuong-140",
  "chuong-141",
  "chuong-142",
  "chuong-143",
  "chuong-144",
  "chuong-145",
  "chuong-146",
  "chuong-147",
  "chuong-148",
  "chuong-149",
  "chuong-150",
  "chuong-151",
  "chuong-152",
  "chuong-153",
  "chuong-154",
  "chuong-155",
  "chuong-156",
  "chuong-157",
  "chuong-158",
  "chuong-159",
  "chuong-160",
  "chuong-161",
  "chuong-162",
  "chuong-163",
  "chuong-164",
  "chuong-165",
  "chuong-166",
  "chuong-167",
  "chuong-168",
  "chuong-169",
  "chuong-170",
  "chuong-171",
  "chuong-172",
  "chuong-173",
  "chuong-174",
  "chuong-175",
  "chuong-176",
  "chuong-177",
  "chuong-178",
  "chuong-179",
  "chuong-180",
  "chuong-181",
  "chuong-182",
  "chuong-183",
  "chuong-184",
  "chuong-185",
  "chuong-186",
  "chuong-187",
  "chuong-188",
  "chuong-189",
  "chuong-190",
  "chuong-191",
  "chuong-192",
  "chuong-193",
  "chuong-194",
  "chuong-195",
  "chuong-196",
  "chuong-197",
  "chuong-198",
  "chuong-199",
  "chuong-200",
  "chuong-201",
  "chuong-202",
  "chuong-203",
  "chuong-204",
  "chuong-205",
  "chuong-206",
  "chuong-207",
  "chuong-208",
  "chuong-209",
  "chuong-210",
  "chuong-211",
  "chuong-212",
  "chuong-213",
  "chuong-214",
  "chuong-215",
  "chuong-216",
  "chuong-217",
  "chuong-218",
  "chuong-219",
  "chuong-220",
  "chuong-221",
  "chuong-222",
  "chuong-223",
  "chuong-224",
  "chuong-225",
  "chuong-226",
  "chuong-227",
  "chuong-228",
  "chuong-229",
  "chuong-230",
  "chuong-231",
  "chuong-232",
  "chuong-233",
  "chuong-234",
  "chuong-235",
  "chuong-236",
  "chuong-237",
  "chuong-238",
  "chuong-239",
  "chuong-240",
  "chuong-241",
  "chuong-242",
  "chuong-243",
  "chuong-244",
  "chuong-245",
  "chuong-246",
  "chuong-247",
  "chuong-248",
  "chuong-249",
  "chuong-250",
  "chuong-251",
  "chuong-252",
  "chuong-253",
  "chuong-254",
  "chuong-255",
  "chuong-256",
  "chuong-257",
  "chuong-258",
  "chuong-259",
  "chuong-260",
  "chuong-261",
  "chuong-262",
  "chuong-263",
  "chuong-264",
  "chuong-265",
  "chuong-266",
  "chuong-267",
  "chuong-268",
  "chuong-269",
  "chuong-270",
  "chuong-271",
  "chuong-272",
  "chuong-273",
  "chuong-274",
  "chuong-275",
  "chuong-276",
  "chuong-277",
  "chuong-278",
  "chuong-279",
  "chuong-280",
  "chuong-281",
  "chuong-282",
  "chuong-283",
  "chuong-284",
  "chuong-285",
  "chuong-286",
  "chuong-287",
  "chuong-288",
  "chuong-289",
  "chuong-290",
  "chuong-291",
  "chuong-292",
  "chuong-293",
  "chuong-294",
  "chuong-295",
  "chuong-296",
  "chuong-297",
  "chuong-298",
  "chuong-299",
  "chuong-300",
  "chuong-301",
  "chuong-302",
  "chuong-303",
  "chuong-304",
  "chuong-305",
  "chuong-306",
  "chuong-307",
  "chuong-308",
  "chuong-309",
  "chuong-310",
  "chuong-311",
  "chuong-312",
  "chuong-313",
  "chuong-314",
  "chuong-315",
  "chuong-316",
  "chuong-317",
  "chuong-318",
  "chuong-319",
  "chuong-320",
  "chuong-321",
  "chuong-322",
  "chuong-323",
  "chuong-324",
  "chuong-325",
  "chuong-326",
  "chuong-327",
  "chuong-328",
  "chuong-329",
  "chuong-330",
  "chuong-331",
  "chuong-332",
  "chuong-333",
  "chuong-334",
  "chuong-335",
  "chuong-336",
  "chuong-337",
  "chuong-338",
  "chuong-339",
  "chuong-340",
  "chuong-341",
  "chuong-342",
  "chuong-343",
  "chuong-344",
  "chuong-345",
  "chuong-346",
  "chuong-347",
  "chuong-348",
  "chuong-349",
  "chuong-350",
  "chuong-351",
  "chuong-352",
  "chuong-353",
  "chuong-354",
  "chuong-355",
  "chuong-356",
  "chuong-357",
  "chuong-358",
  "chuong-359",
  "chuong-360",
  "chuong-361",
  "chuong-362",
  "chuong-363",
  "chuong-364",
  "chuong-365",
  "chuong-366",
  "chuong-367",
  "chuong-368",
  "chuong-369",
  "chuong-370",
  "chuong-371",
  "chuong-372",
  "chuong-373",
  "chuong-374",
  "chuong-375",
  "chuong-376",
  "chuong-377",
  "chuong-378",
  "chuong-379",
  "chuong-380",
  "chuong-381",
  "chuong-382",
  "chuong-383",
  "chuong-384",
  "chuong-385",
  "chuong-386",
  "chuong-387",
  "chuong-388",
  "chuong-389",
  "chuong-390",
  "chuong-391",
  "chuong-392",
  "chuong-393",
  "chuong-394",
  "chuong-395",
  "chuong-396",
  "chuong-397",
  "chuong-398",
  "chuong-399",
  "chuong-400",
  "chuong-401",
  "chuong-402",
  "chuong-403",
  "chuong-404",
  "chuong-405",
  "chuong-406",
  "chuong-407",
  "chuong-408",
  "chuong-409",
  "chuong-410",
  "chuong-411",
  "chuong-412",
  "chuong-413",
  "chuong-414",
  "chuong-415",
  "chuong-416",
  "chuong-417",
  "chuong-418",
  "chuong-419",
  "chuong-420",
  "chuong-421",
  "chuong-422",
  "chuong-423",
  "chuong-424",
  "chuong-425",
  "chuong-426",
  "chuong-427",
  "chuong-428",
  "chuong-429",
  "chuong-430",
  "chuong-431",
  "chuong-432",
  "chuong-433",
  "chuong-434",
  "chuong-435",
  "chuong-436",
  "chuong-437",
  "chuong-438",
  "chuong-439",
  "chuong-440",
  "chuong-441",
  "chuong-442",
  "chuong-443",
  "chuong-444",
  "chuong-445",
  "chuong-446",
  "chuong-447",
  "chuong-448",
  "chuong-449",
  "chuong-450",
  "chuong-451",
  "chuong-452",
  "chuong-453",
  "chuong-454",
  "chuong-455",
  "chuong-456",
  "chuong-457",
  "chuong-458",
  "chuong-459",
  "chuong-460",
  "chuong-461",
  "chuong-462",
  "chuong-463",
  "chuong-464",
  "chuong-465",
  "chuong-466",
  "chuong-467",
  "chuong-468",
  "chuong-469",
  "chuong-470",
  "chuong-471",
  "chuong-472",
  "chuong-473",
  "chuong-474",
  "chuong-475",
  "chuong-476",
  "chuong-477",
  "chuong-478",
  "chuong-479",
  "chuong-480",
  "chuong-481",
  "chuong-482",
  "chuong-483",
  "chuong-484",
  "chuong-485",
  "chuong-486",
  "chuong-487",
  "chuong-488",
  "chuong-489",
  "chuong-490",
  "chuong-491",
  "chuong-492",
  "chuong-493",
  "chuong-494",
  "chuong-495",
  "chuong-496",
  "chuong-497",
  "chuong-498",
  "chuong-499",
  "chuong-500",
  "chuong-501",
  "chuong-502",
  "chuong-503",
  "chuong-504",
  "chuong-505",
  "chuong-506",
  "chuong-507",
  "chuong-508",
  "chuong-509",
  "chuong-510",
  "chuong-511",
  "chuong-512",
  "chuong-513",
  "chuong-514",
  "chuong-515",
  "chuong-516",
  "chuong-517",
  "chuong-518",
  "chuong-519",
  "chuong-520",
  "chuong-521",
  "chuong-522",
  "chuong-523",
  "chuong-524",
  "chuong-525",
  "chuong-526",
  "chuong-527",
  "chuong-528",
  "chuong-529",
  "chuong-530",
  "chuong-531",
  "chuong-532",
  "chuong-533",
  "chuong-534",
  "chuong-535",
  "chuong-536",
  "chuong-537",
  "chuong-538",
  "chuong-539",
  "chuong-540",
  "chuong-541",
  "chuong-542",
  "chuong-543",
  "chuong-544",
  "chuong-545",
  "chuong-546",
  "chuong-547",
  "chuong-548",
  "chuong-549",
  "chuong-550",
  "chuong-551",
  "chuong-552",
  "chuong-553",
  "chuong-554",
  "chuong-555",
  "chuong-556",
  "chuong-557",
  "chuong-558",
  "chuong-559",
  "chuong-560",
  "chuong-561",
  "chuong-562",
  "chuong-563",
  "chuong-564",
  "chuong-565",
  "chuong-566",
  "chuong-567",
  "chuong-568",
  "chuong-569",
  "chuong-570",
  "chuong-571",
  "chuong-572",
  "chuong-573",
  "chuong-574",
  "chuong-575",
  "chuong-576",
  "chuong-577",
  "chuong-578",
  "chuong-579",
  "chuong-580",
  "chuong-581",
  "chuong-582",
  "chuong-583",
  "chuong-584",
  "chuong-585",
  "chuong-586",
  "chuong-587",
  "chuong-588",
  "chuong-589",
  "chuong-590",
  "chuong-591",
  "chuong-592",
  "chuong-593",
  "chuong-594",
  "chuong-595",
  "chuong-596",
  "chuong-597",
  "chuong-598",
  "chuong-599",
  "chuong-600",
  "chuong-601",
  "chuong-602",
  "chuong-603",
  "chuong-604",
  "chuong-605",
  "chuong-606",
  "chuong-607",
  "chuong-608",
  "chuong-609",
  "chuong-610",
  "chuong-611",
  "chuong-612",
  "chuong-613",
  "chuong-614",
  "chuong-615",
  "chuong-616",
  "chuong-617",
  "chuong-618",
  "chuong-619",
  "chuong-620",
  "chuong-621",
  "chuong-622",
  "chuong-623",
  "chuong-624",
  "chuong-625",
  "chuong-626",
  "chuong-627",
  "chuong-628",
  "chuong-629",
  "chuong-630",
  "chuong-631",
  "chuong-632",
  "chuong-633",
  "chuong-634",
  "chuong-635",
  "chuong-636",
  "chuong-637",
  "chuong-638",
  "chuong-639",
  "chuong-640",
  "chuong-641",
  "chuong-642",
  "chuong-643",
  "chuong-644",
  "chuong-645",
  "chuong-646",
  "chuong-647",
  "chuong-648",
  "chuong-649",
  "chuong-650",
  "chuong-651",
  "chuong-652",
  "chuong-653",
  "chuong-654",
  "chuong-655",
  "chuong-656",
  "chuong-657",
  "chuong-658",
  "chuong-659",
  "chuong-660",
  "chuong-661",
  "chuong-662",
  "chuong-663",
  "chuong-664",
  "chuong-665",
  "chuong-666",
  "chuong-667",
  "chuong-668",
  "chuong-669",
  "chuong-670",
  "chuong-671",
  "chuong-672",
  "chuong-673",
  "chuong-674",
  "chuong-675",
  "chuong-676",
  "chuong-677",
  "chuong-678",
  "chuong-679",
  "chuong-680",
  "chuong-681",
  "chuong-682",
  "chuong-683",
  "chuong-684",
  "chuong-685",
  "chuong-686",
  "chuong-687",
  "chuong-688",
  "chuong-689",
  "chuong-690",
  "chuong-691",
  "chuong-692",
  "chuong-693",
  "3243755-chuong-1",
  "3243756-chuong-2",
  "3322388-chuong-3",
];

async function downloadChapter(page, chapterIndex, chapterPath, chapters) {
  const chapterUrl = `${CHAPTER_DOMAIN}/${chapterPath}`;

  await page.goto(chapterUrl);

  console.log("Page chapter loaded!");
  await page.waitForSelector(".chapter-c-content");

  const chapterTitleElementHandle = await page.$("h2");
  const chapterTitle = await chapterTitleElementHandle.evaluate((e) =>
    e.textContent.trim()
  );

  const chapterContentElementHandle = await page.$(
    ".chapter-c-content .box-chap"
  );
  const chapterContent = await chapterContentElementHandle.evaluate((e) =>
    e.textContent.trim()
  );
  const cleanedUpChapterContent = chapterContent
    .split("\n")
    .map((line) => line.trim())
    .filter((line) => line.length > 0)
    .filter((line, index) => index > 0 || !line.startsWith("Chương"))
    .filter(
      (line) =>
        !line.startsWith(
          "Chương trình ủng hộ thương hiệu Việt của Tàng Thư Viện"
        )
    )
    .join("\n");

  await fsPromises.writeFile(
    `./content/${String(chapterIndex).padStart(4, "0")}.txt`,
    cleanedUpChapterContent
  );

  chapters.push([chapterPath, chapterIndex, chapterTitle]);
}

(async () => {
  const browser = await puppeteer.launch({
    args: [
      "--disable-web-security",
      "--disable-features=IsolateOrigins",
      " --disable-site-isolation-trials",
    ],
    headless: true,
  });
  const page = await browser.newPage();

  await page.setViewport({
    width: VIEWPORT_WIDTH,
    height: VIEWPORT_HEIGHT,
    deviceScaleFactor: 1,
  });

  await hideHeadless(page);

  const chapters = [];
  for (let i = 263; i < CHAPTERS.length; i++) {
    await downloadChapter(page, i + 1, CHAPTERS[i], chapters);
  }
  await browser.close();
  await fsPromises.writeFile(
    `./chapters.json`,
    JSON.stringify(chapters, null, 2)
  );
})();
